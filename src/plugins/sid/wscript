from waftools.plugin import plugin
from os.path import realpath

def plugin_configure(conf):
    if not conf.env["HAVE_CXX"]:
        return False
    cfg = conf.create(configurator='pkgconfig')
    cfg.name = 'libsidplay2'
    cfg.uselib = 'sidplay'
    cfg.variables = ['builders']
    if not cfg.run():
        return False

    if not conf.check_header2('sidplay/builders/resid.h'):
        return False
    if not conf.check_library2('resid-builder', uselib='resid'):
        return False

    builders = conf.env['sidplay_BUILDERS']
    if not realpath(builders) in [realpath(i) for i in conf.env['LIBPATH_sidplay']]:
        conf.env['LIBPATH_sidplay'].append("%s" % builders)
        conf.env['LINKFLAGS_sidplay'] = "-Wl,-rpath=%s" % builders
    return True

def plugin_build(bld, obj):
    obj.add_objects = 'xmms_sid_cpp'

    obj = bld.create_obj('cpp', 'objects')
    obj.target = 'xmms_sid_cpp'
    obj.includes = '../../include'
    obj.source = """sidplay_wrapper.cpp md5.cpp""".split()
    obj.uselib = 'sidplay glib2'

configure, build = plugin('sid', configure=plugin_configure,
                          build=plugin_build, extra_libs=['sidplay resid'])
